# æ¯è½®å¯¹è¯å‰å‹ç¼©æ£€æŸ¥è®¾è®¡æ–¹æ¡ˆ

## é—®é¢˜åˆ†æ

### å½“å‰å®ç°çš„é—®é¢˜

**ç°çŠ¶ï¼š** å‹ç¼©æ£€æŸ¥åªåœ¨ `Agent.chat()` å…¥å£å¤„æ‰§è¡Œä¸€æ¬¡

```typescript
public async chat(message: string, context?: ChatContext): Promise<string> {
  if (context) {
    // âŒ åªåœ¨è¿™é‡Œæ£€æŸ¥ä¸€æ¬¡
    await this.checkAndCompact(context);

    // ç„¶åè¿›å…¥å¾ªç¯ï¼Œå¯èƒ½æ‰§è¡Œå¤šè½® LLM è°ƒç”¨å’Œå·¥å…·æ‰§è¡Œ
    const result = await this.runLoop(message, context, { signal: context.signal });
  }
}
```

**é—®é¢˜åœºæ™¯ï¼š**

1. **åˆå§‹æ£€æŸ¥é€šè¿‡**ï¼ˆå¦‚ 60% token ä½¿ç”¨ç‡ï¼‰
2. **è¿›å…¥ Agent å¾ªç¯**
   - ç¬¬ 1 è½®ï¼šç”¨æˆ·æ¶ˆæ¯ + LLM å“åº” + å·¥å…·è°ƒç”¨ â†’ 70% ä½¿ç”¨ç‡
   - ç¬¬ 2 è½®ï¼šå·¥å…·ç»“æœ + LLM å“åº” + å·¥å…·è°ƒç”¨ â†’ 85% ä½¿ç”¨ç‡ âš ï¸
   - ç¬¬ 3 è½®ï¼šç»§ç»­å¢é•¿ â†’ **è¶…å‡ºæ¨¡å‹é™åˆ¶** âŒ

3. **ç»“æœï¼š** å³ä½¿æœ‰å‹ç¼©æœºåˆ¶ï¼Œä»å¯èƒ½åœ¨å¾ªç¯ä¸­è¶…å‡ºä¸Šä¸‹æ–‡é™åˆ¶

---

## è®¾è®¡æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šæ¯è½®å¾ªç¯å¼€å§‹å‰æ£€æŸ¥ï¼ˆæ¨èï¼‰

**æ ¸å¿ƒæ€è·¯ï¼š** åœ¨ `while` å¾ªç¯çš„**æ¯æ¬¡è¿­ä»£å¼€å§‹æ—¶**æ£€æŸ¥å¹¶å‹ç¼©

#### ä¼˜ç‚¹
- âœ… **å®æ—¶ä¿æŠ¤**ï¼šç¡®ä¿æ¯è½® LLM è°ƒç”¨å‰ä¸Šä¸‹æ–‡éƒ½åœ¨å®‰å…¨èŒƒå›´å†…
- âœ… **ç²¾ç¡®æ§åˆ¶**ï¼šå¯ä»¥åœ¨æœ€éœ€è¦çš„æ—¶å€™å‹ç¼©
- âœ… **ç®€å•å®ç°**ï¼šåªéœ€åœ¨å¾ªç¯å†…æ·»åŠ æ£€æŸ¥é€»è¾‘
- âœ… **æ€§èƒ½å¯æ§**ï¼šåªåœ¨éœ€è¦æ—¶æ‰å‹ç¼©ï¼ˆ80% é˜ˆå€¼ï¼‰

#### ç¼ºç‚¹
- âš ï¸ **æ£€æŸ¥å¼€é”€**ï¼šæ¯è½®éƒ½è¦è®¡ç®— tokenï¼ˆä½† TokenCounter å¾ˆå¿«ï¼Œå¯æ¥å—ï¼‰
- âš ï¸ **å¤šæ¬¡å‹ç¼©**ï¼šé•¿å¯¹è¯å¯èƒ½è§¦å‘å¤šæ¬¡å‹ç¼©ï¼ˆè¿™å…¶å®æ˜¯ä¼˜ç‚¹ï¼Œä¿è¯å®‰å…¨ï¼‰

#### å®ç°ä½ç½®

```typescript
// src/agent/Agent.ts - runLoop() æ–¹æ³•

while (turnsCount < maxTurns) {
  // === 1. æ£€æŸ¥ä¸­æ–­ä¿¡å· ===
  if (options?.signal?.aborted) { ... }

  // === 2. æ¯è½®å¾ªç¯å‰æ£€æŸ¥å¹¶å‹ç¼©ï¼ˆæ–°å¢ï¼‰===
  await this.checkAndCompactInLoop(context, turnsCount);

  // === 3. è½®æ¬¡è®¡æ•° ===
  turnsCount++;
  console.log(`ğŸ”„ [è½®æ¬¡ ${turnsCount}/${maxTurns}] è°ƒç”¨ LLM...`);

  // === 4. LLM è°ƒç”¨ ===
  const turnResult = await this.chatService.chat(messages, tools);

  // ... åç»­å·¥å…·è°ƒç”¨é€»è¾‘
}
```

---

### æ–¹æ¡ˆ 2ï¼šåŸºäºæ¶ˆæ¯æ•°é‡é˜ˆå€¼æ£€æŸ¥

**æ ¸å¿ƒæ€è·¯ï¼š** åªåœ¨æ¶ˆæ¯æ•°é‡å¢é•¿åˆ°ä¸€å®šé˜ˆå€¼æ—¶æ£€æŸ¥

#### ä¼˜ç‚¹
- âœ… å‡å°‘æ£€æŸ¥é¢‘ç‡
- âœ… æ€§èƒ½æ›´å¥½ï¼ˆå°‘è®¡ç®— tokenï¼‰

#### ç¼ºç‚¹
- âŒ ä¸ç²¾ç¡®ï¼šæ¶ˆæ¯æ•°é‡ â‰  token æ•°é‡
- âŒ å¯èƒ½é—æ¼ï¼šæŸäº›æ¶ˆæ¯å¾ˆé•¿ä½†æ•°é‡å°‘
- âŒ å¤æ‚åº¦é«˜ï¼šéœ€è¦é¢å¤–çš„è®¡æ•°é€»è¾‘

**ç»“è®ºï¼šä¸æ¨è**ï¼Œå› ä¸º token è®¡æ•°æœ¬èº«å¾ˆå¿«ï¼Œæ²¡å¿…è¦ä¼˜åŒ–è¿™ç‚¹æ€§èƒ½ã€‚

---

### æ–¹æ¡ˆ 3ï¼šå·¥å…·æ‰§è¡Œåæ£€æŸ¥

**æ ¸å¿ƒæ€è·¯ï¼š** åœ¨æ¯æ¬¡å·¥å…·æ‰§è¡Œå®Œæˆåæ£€æŸ¥

#### ä¼˜ç‚¹
- âœ… é’ˆå¯¹æ€§å¼ºï¼šå·¥å…·ç»“æœé€šå¸¸æ˜¯ä¸Šä¸‹æ–‡å¢é•¿çš„ä¸»è¦æ¥æº

#### ç¼ºç‚¹
- âŒ ä¸å¤Ÿå…¨é¢ï¼šLLM å“åº”æœ¬èº«ä¹Ÿå  token
- âŒ æ—¶æœºä¸ä½³ï¼šå·¥å…·æ‰§è¡Œåæ‰æ£€æŸ¥ï¼ŒLLM å“åº”å·²ç»åœ¨æ¶ˆæ¯ä¸­
- âŒ å®ç°å¤æ‚ï¼šéœ€è¦åœ¨å·¥å…·æ‰§è¡Œç®¡é“ä¸­æ’å…¥é€»è¾‘

**ç»“è®ºï¼šä¸æ¨è**ï¼Œä¸å¦‚æ–¹æ¡ˆ 1 ç®€æ´æœ‰æ•ˆã€‚

---

## æœ€ç»ˆæ–¹æ¡ˆï¼šæ–¹æ¡ˆ 1ï¼ˆæ¯è½®å¾ªç¯å‰æ£€æŸ¥ï¼‰

### å®ç°ç»†èŠ‚

#### 1. æ–°å¢æ–¹æ³•ï¼š`checkAndCompactInLoop()`

```typescript
/**
 * åœ¨ Agent å¾ªç¯ä¸­æ£€æŸ¥å¹¶æ‰§è¡Œå‹ç¼©
 * ä¸ checkAndCompact() çš„åŒºåˆ«ï¼š
 * - æ·»åŠ è½®æ¬¡ä¿¡æ¯åˆ°æ—¥å¿—
 * - trigger æ ‡è®°ä¸º 'auto-loop' ä¾¿äºåŒºåˆ†
 * - ä¸åœ¨ç¬¬ä¸€è½®æ£€æŸ¥ï¼ˆå·²åœ¨å…¥å£å¤„æ£€æŸ¥è¿‡ï¼‰
 */
private async checkAndCompactInLoop(
  context: ChatContext,
  currentTurn: number
): Promise<void> {
  // ç¬¬ä¸€è½®è·³è¿‡ï¼ˆå…¥å£å·²æ£€æŸ¥ï¼‰
  if (currentTurn === 0) {
    return;
  }

  const modelName = this.config.model;

  // æ£€æŸ¥æ˜¯å¦éœ€è¦å‹ç¼©
  if (!TokenCounter.shouldCompact(context.messages, modelName)) {
    return; // ä¸éœ€è¦å‹ç¼©
  }

  console.log(`[Agent] [è½®æ¬¡ ${currentTurn}] è§¦å‘å¾ªç¯å†…è‡ªåŠ¨å‹ç¼©`);
  this.emit('compactionStart', { turn: currentTurn });

  try {
    const result = await CompactionService.compact(context.messages, {
      trigger: 'auto',
      modelName,
      apiKey: this.config.apiKey,
      baseURL: this.config.baseUrl,
    });

    if (result.success) {
      context.messages = result.compactedMessages;

      this.emit('compactionComplete', {
        turn: currentTurn,
        preTokens: result.preTokens,
        postTokens: result.postTokens,
        filesIncluded: result.filesIncluded,
      });

      console.log(
        `[Agent] [è½®æ¬¡ ${currentTurn}] å‹ç¼©å®Œæˆ: ${result.preTokens} â†’ ${result.postTokens} tokens`
      );
    } else {
      context.messages = result.compactedMessages;

      this.emit('compactionFallback', {
        turn: currentTurn,
        preTokens: result.preTokens,
        postTokens: result.postTokens,
        error: result.error,
      });
    }

    // ä¿å­˜åˆ° JSONL
    try {
      const contextMgr = this.executionEngine?.getContextManager();
      if (contextMgr && context.sessionId) {
        await contextMgr.saveCompaction(
          context.sessionId,
          result.summary,
          {
            trigger: 'auto',
            preTokens: result.preTokens,
            postTokens: result.postTokens,
            filesIncluded: result.filesIncluded,
          },
          null
        );
        console.log(`[Agent] [è½®æ¬¡ ${currentTurn}] å‹ç¼©æ•°æ®å·²ä¿å­˜åˆ° JSONL`);
      }
    } catch (saveError) {
      console.warn(`[Agent] [è½®æ¬¡ ${currentTurn}] ä¿å­˜å‹ç¼©æ•°æ®å¤±è´¥:`, saveError);
    }
  } catch (error) {
    console.error(`[Agent] [è½®æ¬¡ ${currentTurn}] å‹ç¼©å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ`, error);
    this.emit('compactionFailed', { turn: currentTurn, error });
  }
}
```

#### 2. ä¿®æ”¹ `runLoop()` æ–¹æ³•

åœ¨ `while` å¾ªç¯å†…éƒ¨ï¼Œ**åœ¨è½®æ¬¡è®¡æ•°ä¹‹å‰**æ·»åŠ å‹ç¼©æ£€æŸ¥ï¼š

```typescript
while (turnsCount < maxTurns) {
  // === 1. æ£€æŸ¥ä¸­æ–­ä¿¡å· ===
  if (options?.signal?.aborted) {
    return { success: false, error: { type: 'aborted', ... } };
  }

  // === 2. æ¯è½®å¾ªç¯å‰æ£€æŸ¥å¹¶å‹ç¼©ï¼ˆæ–°å¢ï¼‰===
  await this.checkAndCompactInLoop(context, turnsCount);

  // === 3. è½®æ¬¡è®¡æ•° ===
  turnsCount++;
  console.log(`ğŸ”„ [è½®æ¬¡ ${turnsCount}/${maxTurns}] è°ƒç”¨ LLM...`);

  // === 4. è§¦å‘è½®æ¬¡å¼€å§‹äº‹ä»¶ ===
  this.emit('loopTurnStart', { turn: turnsCount, maxTurns });
  options?.onTurnStart?.({ turn: turnsCount, maxTurns });

  // === 5. è°ƒç”¨ LLM ===
  const turnResult = await this.chatService.chat(messages, tools);

  // ... åç»­å·¥å…·è°ƒç”¨é€»è¾‘
}
```

**å…³é”®ç‚¹ï¼š**
- âœ… åœ¨ `turnsCount++` **ä¹‹å‰**æ£€æŸ¥ï¼Œæ‰€ä»¥ä¼ å…¥çš„æ˜¯å½“å‰è½®æ¬¡ï¼ˆ0, 1, 2...ï¼‰
- âœ… ç¬¬ä¸€è½®ï¼ˆturnsCount = 0ï¼‰è·³è¿‡æ£€æŸ¥ï¼Œé¿å…é‡å¤ï¼ˆå…¥å£å·²æ£€æŸ¥ï¼‰
- âœ… ä»ç¬¬äºŒè½®å¼€å§‹ï¼ˆturnsCount = 1ï¼‰ï¼Œæ¯è½®éƒ½æ£€æŸ¥

#### 3. ä¿ç•™å…¥å£å¤„çš„æ£€æŸ¥

```typescript
public async chat(message: string, context?: ChatContext): Promise<string> {
  if (context) {
    // âœ… ä¿ç•™ï¼šå¤„ç†è¿›å…¥ Agent å¾ªç¯å‰çš„åˆå§‹å‹ç¼©
    await this.checkAndCompact(context);

    const result = await this.runLoop(message, context, { signal: context.signal });
    // ...
  }
}
```

**åŸå› ï¼š**
- ç”¨æˆ·å¯èƒ½åŠ è½½ä¸€ä¸ªå·²ç»æ¥è¿‘é™åˆ¶çš„å†å²ä¼šè¯
- å…¥å£æ£€æŸ¥ç¡®ä¿è¿›å…¥å¾ªç¯å‰ä¸Šä¸‹æ–‡æ˜¯å®‰å…¨çš„
- å¾ªç¯å†…æ£€æŸ¥ç¡®ä¿æ¯è½®æ‰§è¡Œå‰ä¸Šä¸‹æ–‡æ˜¯å®‰å…¨çš„

---

## æ€§èƒ½å½±å“åˆ†æ

### Token è®¡æ•°æ€§èƒ½

**js-tiktoken æ€§èƒ½æµ‹è¯•ï¼ˆä¼°ç®—ï¼‰ï¼š**
- 1000 æ¡æ¶ˆæ¯ Ã— å¹³å‡ 100 tokens = 100,000 tokens
- è®¡æ•°æ—¶é—´ï¼šçº¦ **5-10ms**ï¼ˆçº¯ JS å®ç°ï¼Œå¾ˆå¿«ï¼‰

**æ¯è½®å¾ªç¯å¼€é”€ï¼š**
- æ£€æŸ¥é¢‘ç‡ï¼šæ¯è½® 1 æ¬¡
- å¹³å‡è½®æ¬¡ï¼š3-10 è½®
- æ€»å¼€é”€ï¼š**15-100ms**ï¼ˆå¯å¿½ç•¥ï¼Œç›¸æ¯” LLM è°ƒç”¨çš„ç§’çº§å»¶è¿Ÿï¼‰

### å‹ç¼©é¢‘ç‡

**æœ€åæƒ…å†µï¼ˆé¢‘ç¹å‹ç¼©ï¼‰ï¼š**
- åœºæ™¯ï¼šé•¿å¯¹è¯ + å¤§é‡å·¥å…·è°ƒç”¨
- æ¯ 5-10 è½®è§¦å‘ 1 æ¬¡å‹ç¼©
- å‹ç¼©æ—¶é—´ï¼š5-30 ç§’ï¼ˆå–å†³äºæ¶ˆæ¯æ•°é‡å’Œ LLM å“åº”é€Ÿåº¦ï¼‰

**æ­£å¸¸æƒ…å†µï¼š**
- å¤§éƒ¨åˆ†å¯¹è¯ä¸ä¼šè§¦å‘å‹ç¼©ï¼ˆ< 80% é˜ˆå€¼ï¼‰
- å³ä½¿è§¦å‘ï¼Œä¹Ÿåªå‹ç¼©ä¸€æ¬¡
- ç”¨æˆ·æ— æ„ŸçŸ¥ï¼ˆåå°å¼‚æ­¥è¿›è¡Œï¼‰

---

## äº‹ä»¶é€šçŸ¥å¢å¼º

### æ–°å¢äº‹ä»¶å­—æ®µ

ä¸ºå‹ç¼©äº‹ä»¶æ·»åŠ  `turn` å­—æ®µï¼Œä¾¿äº UI æ˜¾ç¤ºï¼š

```typescript
// å‹ç¼©å¼€å§‹
this.emit('compactionStart', { turn: currentTurn });

// å‹ç¼©å®Œæˆ
this.emit('compactionComplete', {
  turn: currentTurn,
  preTokens: result.preTokens,
  postTokens: result.postTokens,
  filesIncluded: result.filesIncluded,
});

// é™çº§ç­–ç•¥
this.emit('compactionFallback', {
  turn: currentTurn,
  preTokens: result.preTokens,
  postTokens: result.postTokens,
  error: result.error,
});

// å‹ç¼©å¤±è´¥
this.emit('compactionFailed', {
  turn: currentTurn,
  error,
});
```

### UI æ˜¾ç¤ºå»ºè®®

```
ğŸ”„ [è½®æ¬¡ 5/100] è°ƒç”¨ LLM...
âš ï¸ ä¸Šä¸‹æ–‡æ¥è¿‘é™åˆ¶ï¼Œæ­£åœ¨å‹ç¼©... (è½®æ¬¡ 5)
âœ… å‹ç¼©å®Œæˆï¼š15,234 â†’ 3,456 tokens (-77.3%)
ğŸ”„ [è½®æ¬¡ 6/100] è°ƒç”¨ LLM...
```

---

## æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1ï¼šå…¥å£å‹ç¼©

```
åˆå§‹çŠ¶æ€ï¼šåŠ è½½å†å²ä¼šè¯ï¼Œ85% token ä½¿ç”¨ç‡
å…¥å£æ£€æŸ¥ï¼šè§¦å‘å‹ç¼© â†’ é™è‡³ 20%
å¾ªç¯å¼€å§‹ï¼šæ­£å¸¸æ‰§è¡Œ
```

### åœºæ™¯ 2ï¼šå¾ªç¯å†…å‹ç¼©

```
åˆå§‹çŠ¶æ€ï¼š60% token ä½¿ç”¨ç‡
å…¥å£æ£€æŸ¥ï¼šæœªè§¦å‘
ç¬¬ 1 è½®ï¼šå·¥å…·è°ƒç”¨ â†’ 70%
ç¬¬ 2 è½®ï¼šå·¥å…·è°ƒç”¨ â†’ 82% â†’ è§¦å‘å‹ç¼© â†’ é™è‡³ 25%
ç¬¬ 3 è½®ï¼šç»§ç»­æ‰§è¡Œ
```

### åœºæ™¯ 3ï¼šå¤šæ¬¡å‹ç¼©

```
åˆå§‹çŠ¶æ€ï¼š50% token ä½¿ç”¨ç‡
ç¬¬ 1-5 è½®ï¼šé€æ¸å¢é•¿è‡³ 82% â†’ å‹ç¼© â†’ é™è‡³ 20%
ç¬¬ 6-10 è½®ï¼šå†æ¬¡å¢é•¿è‡³ 85% â†’ å†æ¬¡å‹ç¼© â†’ é™è‡³ 20%
```

### åœºæ™¯ 4ï¼šæ— éœ€å‹ç¼©

```
åˆå§‹çŠ¶æ€ï¼š30% token ä½¿ç”¨ç‡
æ¯è½®æ£€æŸ¥ï¼š< 80%ï¼Œè·³è¿‡
æ•´ä¸ªå¯¹è¯ï¼šæ— å‹ç¼©
```

---

## å®ç°æ–‡ä»¶æ¸…å•

### ä¿®æ”¹æ–‡ä»¶

1. **src/agent/Agent.ts**
   - æ–°å¢æ–¹æ³•ï¼š`checkAndCompactInLoop(context, currentTurn)`
   - ä¿®æ”¹æ–¹æ³•ï¼š`runLoop()` - åœ¨ while å¾ªç¯å†…æ·»åŠ è°ƒç”¨

### æµ‹è¯•æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰

1. **tests/integration/compaction-loop.test.ts**
   - æµ‹è¯•å¾ªç¯å†…å‹ç¼©è§¦å‘
   - æµ‹è¯•å¤šæ¬¡å‹ç¼©åœºæ™¯
   - æµ‹è¯•æ€§èƒ½å½±å“

---

## é£é™©è¯„ä¼°

### æ½œåœ¨é£é™©

1. **å‹ç¼©è¿‡äºé¢‘ç¹**
   - ç¼“è§£ï¼š80% é˜ˆå€¼ + 20% ä¿ç•™ï¼Œç¡®ä¿è‡³å°‘ 5 è½®åæ‰å†æ¬¡è§¦å‘
   - ç›‘æ§ï¼šæ·»åŠ å‹ç¼©é¢‘ç‡ç»Ÿè®¡æ—¥å¿—

2. **å‹ç¼©é˜»å¡å¾ªç¯**
   - ç¼“è§£ï¼šå‹ç¼©é€šå¸¸ < 30 ç§’ï¼Œå¯æ¥å—
   - ä¼˜åŒ–ï¼šæœªæ¥å¯è€ƒè™‘å¼‚æ­¥å‹ç¼©ï¼ˆå¤æ‚åº¦é«˜ï¼‰

3. **ä¸Šä¸‹æ–‡ä¸ä¸€è‡´**
   - ç¼“è§£ï¼šå‹ç¼©åç«‹å³æ›´æ–° `context.messages`
   - éªŒè¯ï¼šå‹ç¼©ç»“æœç›´æ¥åº”ç”¨åˆ°ä¸‹ä¸€è½® LLM è°ƒç”¨

### å®‰å…¨ä¿éšœ

1. âœ… é™çº§ç­–ç•¥ï¼šLLM å¤±è´¥æ—¶ä½¿ç”¨æˆªæ–­
2. âœ… é”™è¯¯å¤„ç†ï¼šå‹ç¼©å¤±è´¥ä¸é˜»å¡å¯¹è¯
3. âœ… æ—¥å¿—è®°å½•ï¼šæ‰€æœ‰å‹ç¼©äº‹ä»¶éƒ½æœ‰æ—¥å¿—
4. âœ… äº‹ä»¶é€šçŸ¥ï¼šUI å¯å®æ—¶æ˜¾ç¤ºå‹ç¼©çŠ¶æ€

---

## æ€»ç»“

### å…³é”®å†³ç­–

1. **æ£€æŸ¥æ—¶æœº**ï¼šæ¯è½®å¾ªç¯å¼€å§‹å‰ï¼ˆwhile å¾ªç¯å†…ï¼‰
2. **æ£€æŸ¥é¢‘ç‡**ï¼šæ¯è½®éƒ½æ£€æŸ¥ï¼Œä½†åªåœ¨ â‰¥80% æ—¶å‹ç¼©
3. **ç¬¬ä¸€è½®è·³è¿‡**ï¼šé¿å…ä¸å…¥å£æ£€æŸ¥é‡å¤
4. **äº‹ä»¶å¢å¼º**ï¼šæ·»åŠ  `turn` å­—æ®µä¾¿äºè°ƒè¯•å’Œ UI æ˜¾ç¤º

### é¢„æœŸæ•ˆæœ

- âœ… **100% å®‰å…¨**ï¼šç¡®ä¿æ°¸è¿œä¸ä¼šè¶…å‡ºä¸Šä¸‹æ–‡é™åˆ¶
- âœ… **æ€§èƒ½å¯æ§**ï¼šæ£€æŸ¥å¼€é”€ < 10msï¼Œå‹ç¼©é¢‘ç‡ä½
- âœ… **ç”¨æˆ·é€æ˜**ï¼šè‡ªåŠ¨å¤„ç†ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„
- âœ… **å¯è§‚æµ‹æ€§**ï¼šå®Œæ•´çš„æ—¥å¿—å’Œäº‹ä»¶é€šçŸ¥

### å®ç°ä¼˜å…ˆçº§

1. **é«˜ä¼˜å…ˆçº§**ï¼šå®ç° `checkAndCompactInLoop()` æ–¹æ³•
2. **é«˜ä¼˜å…ˆçº§**ï¼šä¿®æ”¹ `runLoop()` æ·»åŠ è°ƒç”¨
3. **ä¸­ä¼˜å…ˆçº§**ï¼šå¢å¼ºäº‹ä»¶é€šçŸ¥ï¼ˆæ·»åŠ  turn å­—æ®µï¼‰
4. **ä½ä¼˜å…ˆçº§**ï¼šç¼–å†™é›†æˆæµ‹è¯•

---

## ä¸‹ä¸€æ­¥

1. âœ… æ–¹æ¡ˆè®¾è®¡å®Œæˆ
2. â³ æ›´æ–°å®ç°è®¡åˆ’æ–‡æ¡£
3. â³ å®ç°ä»£ç ä¿®æ”¹
4. â³ éªŒè¯æµ‹è¯•
