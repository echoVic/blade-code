# Task å·¥å…·é‡æ„ V2 - ç®€æ´è®¾è®¡

> é‡æ„æ—¥æœŸï¼š2025-11-14
> è®¾è®¡ç†å¿µï¼šå‚è€ƒ Claude Code å®˜æ–¹ï¼Œé‡‡ç”¨æœ€å°åŒ–é…ç½®ã€æ¨¡å‹å†³ç­–çš„è®¾è®¡å“²å­¦

## ğŸ¯ é‡æ„ç›®æ ‡

è§£å†³ä¹‹å‰å®ç°çš„æ ¸å¿ƒé—®é¢˜ï¼š
1. âŒ **subagent_type å†™æ­»** - å¼ºåˆ¶æŒ‡å®š `file-search`ã€`code-analysis` ç­‰ç±»å‹
2. âŒ **ç³»ç»Ÿæç¤ºè¯å†™æ­»** - åœ¨ Markdown æ–‡ä»¶ä¸­ç¡¬ç¼–ç å›ºå®šæç¤ºè¯
3. âŒ **å·¥å…·æè¿°å†—é•¿** - ç¡¬ç¼–ç æ‰€æœ‰ subagent çš„è¯¦ç»†è¯´æ˜
4. âŒ **ä¸è®©æ¨¡å‹å†³ç­–** - é™åˆ¶äº†æ¨¡å‹çš„è‡ªç”±åº¦å’Œé€‚åº”æ€§

## âœ… æ–°è®¾è®¡æ ¸å¿ƒåŸåˆ™

### 1. æœ€å°åŒ–é…ç½®
```typescript
// æ—§è®¾è®¡ï¼ˆ4 ä¸ªå¿…éœ€å‚æ•° + å¤æ‚é…ç½®ï¼‰
{
  description: string,
  subagent_type: 'file-search' | 'code-analysis' | 'codebase-explorer',
  prompt: string,
  run_in_background?: boolean
}

// æ–°è®¾è®¡ï¼ˆ2 ä¸ªå¿…éœ€å‚æ•° + 1 ä¸ªå¯é€‰ï¼‰
{
  description: string,  // 3-10 ä¸ªè¯
  prompt: string,       // è¯¦ç»†æŒ‡ä»¤
  model?: 'haiku' | 'sonnet' | 'opus'  // å¯é€‰
}
```

### 2. æ¨¡å‹å†³ç­–
- **æ—§è®¾è®¡**: éœ€è¦é¢„å…ˆæŒ‡å®š `file-search` æˆ– `code-analysis`
- **æ–°è®¾è®¡**: æ¨¡å‹æ ¹æ®ä»»åŠ¡å†…å®¹è‡ªåŠ¨å†³å®šä½¿ç”¨å“ªäº›å·¥å…·å’Œç­–ç•¥

### 3. åŠ¨æ€æç¤ºè¯ç”Ÿæˆ
```typescript
// æ—§è®¾è®¡ï¼šå›ºå®šçš„ Markdown æ–‡ä»¶
src/agents/builtin/file-search.md  // å›ºå®šæç¤ºè¯
src/agents/builtin/code-analysis.md  // å›ºå®šæç¤ºè¯

// æ–°è®¾è®¡ï¼šåŠ¨æ€ç”Ÿæˆå‡½æ•°
function buildDynamicSystemPrompt(taskPrompt: string, model: string): string {
  const basePrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ AI åŠ©æ‰‹ï¼Œè´Ÿè´£è‡ªä¸»å®Œæˆä»¥ä¸‹ä»»åŠ¡ï¼š

${taskPrompt}

## æ‰§è¡ŒæŒ‡å—
ä½ å¯ä»¥ä½¿ç”¨æ‰€æœ‰å¯ç”¨çš„å·¥å…·æ¥å®Œæˆä»»åŠ¡ã€‚æ ¹æ®ä»»åŠ¡éœ€æ±‚è‡ªä¸»å†³å®šï¼š
- ä½¿ç”¨å“ªäº›å·¥å…·
- æ‰§è¡Œçš„æ­¥éª¤å’Œé¡ºåº
- è¾“å‡ºçš„æ ¼å¼å’Œç»“æ„
...`;

  // æ ¹æ®æ¨¡å‹è°ƒæ•´æç¤º
  if (model === 'haiku') {
    return basePrompt + '\n\n**æ³¨æ„**: ä¼˜å…ˆè€ƒè™‘é€Ÿåº¦å’Œæ•ˆç‡';
  }
  ...
}
```

### 4. æ— å›ºå®šé…ç½®
- **æ—§è®¾è®¡**: éœ€è¦åœ¨ `.blade/agents/*.md` ä¸­é…ç½®
- **æ–°è®¾è®¡**: ä¸éœ€è¦ä»»ä½•é…ç½®æ–‡ä»¶ï¼Œå¼€ç®±å³ç”¨

## ğŸ“ API å¯¹æ¯”

### æ—§ APIï¼ˆå¤æ‚ï¼‰
```typescript
Task({
  description: 'æŸ¥æ‰¾æµ‹è¯•æ–‡ä»¶',
  subagent_type: 'file-search',  // âŒ å¿…é¡»æŒ‡å®šç±»å‹
  prompt: 'æŸ¥æ‰¾é¡¹ç›®ä¸­æ‰€æœ‰çš„æµ‹è¯•æ–‡ä»¶...',
  run_in_background: false
})
```

### æ–° APIï¼ˆç®€æ´ï¼‰
```typescript
Task({
  description: 'æŸ¥æ‰¾æµ‹è¯•æ–‡ä»¶',
  prompt: 'æŸ¥æ‰¾é¡¹ç›®ä¸­æ‰€æœ‰çš„æµ‹è¯•æ–‡ä»¶...',
  model: 'sonnet'  // âœ… å¯é€‰ï¼Œé»˜è®¤ sonnet
})
```

## ğŸ”§ å®ç°ç»†èŠ‚

### 1. agentFactory æœºåˆ¶

**ä½ç½®**: `src/ui/hooks/useCommandHandler.ts:136-148`

```typescript
useEffect(() => {
  // è®¾ç½® Task å·¥å…·çš„ Agent å·¥å‚å‡½æ•°
  setTaskToolAgentFactory(async (customSystemPrompt?: string) => {
    // åˆ›å»ºå­ Agent
    // å¦‚æœæä¾›äº† customSystemPromptï¼Œåˆ™å®Œå…¨æ›¿æ¢ç³»ç»Ÿæç¤ºè¯
    return await Agent.create({
      systemPrompt: customSystemPrompt || replaceSystemPrompt,
      appendSystemPrompt: customSystemPrompt ? undefined : appendSystemPrompt,
      maxTurns: maxTurns,
    });
  });
}, [replaceSystemPrompt, appendSystemPrompt, maxTurns]);
```

**ç‰¹ç‚¹**:
- âœ… æ”¯æŒä¼ å…¥è‡ªå®šä¹‰ç³»ç»Ÿæç¤ºè¯
- âœ… è‡ªåŠ¨åœ¨ UI å¯åŠ¨æ—¶åˆå§‹åŒ–
- âœ… å¤ç”¨ä¸» Agent çš„é…ç½®ï¼ˆmaxTurns ç­‰ï¼‰

### 2. åŠ¨æ€æç¤ºè¯ç”Ÿæˆ

**ä½ç½®**: `src/tools/builtin/task/task.ts:249-292`

```typescript
function buildDynamicSystemPrompt(taskPrompt: string, model: string): string {
  const basePrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ AI åŠ©æ‰‹ï¼Œè´Ÿè´£è‡ªä¸»å®Œæˆä»¥ä¸‹ä»»åŠ¡ï¼š

${taskPrompt}

## æ‰§è¡ŒæŒ‡å—
ä½ å¯ä»¥ä½¿ç”¨æ‰€æœ‰å¯ç”¨çš„å·¥å…·æ¥å®Œæˆä»»åŠ¡ã€‚æ ¹æ®ä»»åŠ¡éœ€æ±‚è‡ªä¸»å†³å®šï¼š
- ä½¿ç”¨å“ªäº›å·¥å…·
- æ‰§è¡Œçš„æ­¥éª¤å’Œé¡ºåº
- è¾“å‡ºçš„æ ¼å¼å’Œç»“æ„

## å¯ç”¨å·¥å…·
- **Read**: è¯»å–æ–‡ä»¶å†…å®¹
- **Write**: åˆ›å»ºæˆ–è¦†ç›–æ–‡ä»¶
- **Edit**: ç¼–è¾‘æ–‡ä»¶ï¼ˆå­—ç¬¦ä¸²æ›¿æ¢ï¼‰
- **Grep**: æœç´¢æ–‡ä»¶å†…å®¹ï¼ˆæ”¯æŒæ­£åˆ™ï¼‰
- **Glob**: æŸ¥æ‰¾æ–‡ä»¶ï¼ˆæ”¯æŒé€šé…ç¬¦ï¼‰
- **Bash**: æ‰§è¡Œ Shell å‘½ä»¤
- **WebSearch**: ç½‘ç»œæœç´¢
- **WebFetch**: è·å–ç½‘é¡µå†…å®¹

## æ‰§è¡ŒåŸåˆ™
1. **ç³»ç»Ÿæ€§æ€è€ƒ**: åˆ†æä»»åŠ¡ï¼Œåˆ¶å®šè®¡åˆ’ï¼Œé€æ­¥æ‰§è¡Œ
2. **é«˜æ•ˆå·¥å…·ä½¿ç”¨**: ä¼˜å…ˆä½¿ç”¨ä¸“é—¨å·¥å…·ï¼Œé¿å…é‡å¤æ“ä½œ
3. **å®Œæ•´è¾“å‡º**: ç¡®ä¿è¿”å›çš„ç»“æœå®Œæ•´ã€æ¸…æ™°ã€æœ‰ç”¨
4. **é”™è¯¯å¤„ç†**: é‡åˆ°é”™è¯¯æ—¶å°è¯•æ›¿ä»£æ–¹æ¡ˆ

å½“ä»»åŠ¡å®Œæˆæ—¶ï¼Œç›´æ¥è¿”å›æœ€ç»ˆç»“æœã€‚`;

  // æ ¹æ®æ¨¡å‹æ·»åŠ ç‰¹å®šæç¤º
  if (model === 'haiku') {
    return basePrompt + '\n\n**æ³¨æ„**: ä¼˜å…ˆè€ƒè™‘é€Ÿåº¦å’Œæ•ˆç‡ï¼Œå¿«é€Ÿå®Œæˆä»»åŠ¡ã€‚';
  } else if (model === 'opus') {
    return basePrompt + '\n\n**æ³¨æ„**: è¿½æ±‚é«˜è´¨é‡è¾“å‡ºï¼Œæ·±å…¥åˆ†æï¼Œæä¾›è¯¦ç»†çš„ç»“æœå’Œå»ºè®®ã€‚';
  }

  return basePrompt;
}
```

**ç‰¹ç‚¹**:
- âœ… å°†ä»»åŠ¡æè¿°åµŒå…¥åˆ°æç¤ºè¯ä¸­
- âœ… åˆ—å‡ºæ‰€æœ‰å¯ç”¨å·¥å…·ï¼ˆè®©æ¨¡å‹è‡ªå·±é€‰æ‹©ï¼‰
- âœ… æ ¹æ®æ¨¡å‹è°ƒæ•´æç¤ºï¼ˆhaiku å¿«é€Ÿï¼Œopus æ·±å…¥ï¼‰

### 3. å·¥å…·æ‰§è¡Œæµç¨‹

```typescript
// 1. åŠ¨æ€ç”Ÿæˆç³»ç»Ÿæç¤ºè¯
const dynamicSystemPrompt = buildDynamicSystemPrompt(prompt, model);

// 2. åˆ›å»ºå­ Agentï¼ˆä¼ å…¥åŠ¨æ€æç¤ºè¯ï¼‰
const subAgent = await agentFactory(dynamicSystemPrompt);

// 3. æ‰§è¡Œå­ Agent å¾ªç¯
const result = await subAgent.runAgenticLoop(prompt, subContext, {
  maxTurns: 20,
  signal,
});
```

**ç‰¹ç‚¹**:
- âœ… ç³»ç»Ÿæç¤ºè¯åœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆ
- âœ… æ¯ä¸ªä»»åŠ¡å¯ä»¥æœ‰ä¸åŒçš„æç¤ºè¯
- âœ… é™åˆ¶æœ€å¤§ 20 å›åˆï¼ˆé˜²æ­¢æ— é™å¾ªç¯ï¼‰

## ğŸ“Š ä»£ç ç»Ÿè®¡å¯¹æ¯”

| æŒ‡æ ‡ | æ—§å®ç° | æ–°å®ç° | æ”¹è¿› |
|-----|-------|-------|------|
| task.ts è¡Œæ•° | 359 è¡Œ | 293 è¡Œ | -18% |
| å‚æ•°æ•°é‡ | 4 ä¸ª | 3 ä¸ª | -25% |
| å¿…éœ€å‚æ•° | 3 ä¸ª | 2 ä¸ª | -33% |
| å·¥å…·æè¿°é•¿åº¦ | ~150 è¡Œ | ~50 è¡Œ | -67% |
| é…ç½®æ–‡ä»¶æ•°é‡ | 3 ä¸ª MD | 0 ä¸ª | -100% |
| å¯¼å‡ºæ•°é‡ | 7 ä¸ª | 2 ä¸ª | -71% |

## ğŸ¨ ç”¨æˆ·ä½“éªŒæ”¹è¿›

### æ—§è®¾è®¡ï¼ˆå¤æ‚ï¼‰
```typescript
// âŒ éœ€è¦è®°ä½æ‰€æœ‰ subagent ç±»å‹
Task({
  description: 'åˆ†æä¾èµ–',
  subagent_type: 'code-analysis',  // å¿…é¡»çŸ¥é“æœ‰è¿™ä¸ªç±»å‹
  prompt: 'åˆ†æé¡¹ç›®ä¾èµ–...'
})

// âŒ å¦‚æœé€‰é”™ç±»å‹ï¼Œæ•ˆæœä¸ä½³
Task({
  description: 'æŸ¥æ‰¾æ–‡ä»¶',
  subagent_type: 'code-analysis',  // åº”è¯¥ç”¨ file-search
  prompt: 'æŸ¥æ‰¾æ‰€æœ‰æµ‹è¯•æ–‡ä»¶'
})
```

### æ–°è®¾è®¡ï¼ˆç®€æ´ï¼‰
```typescript
// âœ… åªéœ€æè¿°ä»»åŠ¡ï¼Œæ¨¡å‹è‡ªå·±å†³å®šç­–ç•¥
Task({
  description: 'åˆ†æä¾èµ–',
  prompt: 'åˆ†æé¡¹ç›®ä¾èµ–åŒ…ï¼Œæ£€æŸ¥è¿‡æ—¶å’Œå®‰å…¨æ¼æ´'
})

// âœ… æ¨¡å‹ä¼šè‡ªåŠ¨é€‰æ‹©åˆé€‚çš„å·¥å…·
Task({
  description: 'æŸ¥æ‰¾æ–‡ä»¶',
  prompt: 'æŸ¥æ‰¾æ‰€æœ‰æµ‹è¯•æ–‡ä»¶'
})
```

## ğŸ“ æ–‡ä»¶å˜æ›´

### ä¿®æ”¹çš„æ–‡ä»¶
- `src/tools/builtin/task/task.ts` - é‡æ„ä¸ºç®€æ´è®¾è®¡
- `src/tools/builtin/task/index.ts` - ç®€åŒ–å¯¼å‡º
- `src/ui/hooks/useCommandHandler.ts` - æ·»åŠ  agentFactory è®¾ç½®

### æš‚å­˜åŒºï¼ˆæ—§å®ç°ï¼Œä¿ç•™å¾…å‚è€ƒï¼‰
- `src/agents/*` - å®Œæ•´çš„ subagent ç³»ç»Ÿ
- `src/agents/builtin/*.md` - å›ºå®šçš„ç³»ç»Ÿæç¤ºè¯é…ç½®
- `docs/development/subagents-*.md` - è®¾è®¡æ–‡æ¡£
- `src/tools/builtin/task/{cancelTask,taskList,taskStatus}.ts` - é¢å¤–çš„ä»»åŠ¡ç®¡ç†å·¥å…·

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šåˆ†æé¡¹ç›®ä¾èµ–
```typescript
Task({
  description: 'åˆ†æé¡¹ç›®ä¾èµ–',
  prompt: 'åˆ†æ package.json ä¸­çš„ä¾èµ–åŒ…ï¼Œæ£€æŸ¥ï¼š1) è¿‡æ—¶çš„åŒ… 2) å­˜åœ¨å®‰å…¨æ¼æ´çš„åŒ… 3) å»ºè®®çš„æ›´æ–°æ–¹æ¡ˆã€‚ä»¥ Markdown è¡¨æ ¼æ ¼å¼è¾“å‡ºã€‚'
})
```

### ç¤ºä¾‹ 2ï¼šæŸ¥æ‰¾æµ‹è¯•æ–‡ä»¶
```typescript
Task({
  description: 'æŸ¥æ‰¾æµ‹è¯•æ–‡ä»¶',
  prompt: 'æŸ¥æ‰¾é¡¹ç›®ä¸­æ‰€æœ‰çš„æµ‹è¯•æ–‡ä»¶ï¼ˆ.test.ts, .spec.tsï¼‰ï¼Œåˆ—å‡ºæ–‡ä»¶è·¯å¾„å’Œæ¯ä¸ªæµ‹è¯•æ–‡ä»¶çš„ä¸»è¦æµ‹è¯•å†…å®¹ã€‚'
})
```

### ç¤ºä¾‹ 3ï¼šç”Ÿæˆ API æ–‡æ¡£ï¼ˆä½¿ç”¨ opusï¼‰
```typescript
Task({
  description: 'ç”Ÿæˆ API æ–‡æ¡£',
  prompt: 'åˆ†æ src/api/ ç›®å½•ä¸‹çš„æ‰€æœ‰ API è·¯ç”±ï¼Œç”Ÿæˆå®Œæ•´çš„ API æ–‡æ¡£ï¼ŒåŒ…æ‹¬ï¼šè·¯ç”±ã€è¯·æ±‚å‚æ•°ã€å“åº”æ ¼å¼ã€ç¤ºä¾‹ã€‚',
  model: 'opus'  // ä½¿ç”¨é«˜è´¨é‡æ¨¡å‹
})
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ç³»ç»Ÿæç¤ºè¯é™åˆ¶
ç”±äº `Agent.create()` çš„ `systemPrompt` å‚æ•°ä¼š**å®Œå…¨æ›¿æ¢**é»˜è®¤ç³»ç»Ÿæç¤ºè¯ï¼ŒåŠ¨æ€ç”Ÿæˆçš„æç¤ºè¯éœ€è¦åŒ…å«æ‰€æœ‰å¿…è¦çš„æŒ‡ä»¤ã€‚

### 2. æœ€å¤§å›åˆæ•°
å­ Agent é™åˆ¶ä¸º 20 å›åˆï¼Œé˜²æ­¢æ— é™å¾ªç¯ã€‚å¦‚æœä»»åŠ¡å¤æ‚ï¼Œéœ€è¦åœ¨ prompt ä¸­æ˜ç¡®æŒ‡å¯¼æ¨¡å‹é«˜æ•ˆæ‰§è¡Œã€‚

### 3. å·¥å…·é€‰æ‹©
æ¨¡å‹ä¼šæ ¹æ®ä»»åŠ¡æè¿°è‡ªåŠ¨é€‰æ‹©å·¥å…·ï¼Œä½†å¯èƒ½ä¸æ˜¯æœ€ä¼˜ã€‚å¦‚æœéœ€è¦ç‰¹å®šå·¥å…·ï¼Œå¯ä»¥åœ¨ prompt ä¸­æ˜ç¡®æç¤ºï¼š
```typescript
prompt: 'ä½¿ç”¨ Grep æœç´¢æ‰€æœ‰åŒ…å« "API" çš„æ–‡ä»¶...'
```

## ğŸ”® æœªæ¥æ”¹è¿›æ–¹å‘

### 1. æ”¯æŒæ›´å¤šæ¨¡å‹å‚æ•°
```typescript
{
  description: string,
  prompt: string,
  model?: string,
  temperature?: number,  // ğŸ†• æ§åˆ¶åˆ›é€ æ€§
  maxTurns?: number,     // ğŸ†• è‡ªå®šä¹‰å›åˆæ•°
}
```

### 2. æç¤ºè¯æ¨¡æ¿ç³»ç»Ÿ
```typescript
// é¢„å®šä¹‰çš„æç¤ºè¯æ¨¡æ¿
const templates = {
  'file-search': (task) => `ä¸“æ³¨äºæ–‡ä»¶æœç´¢çš„æç¤ºè¯...`,
  'code-analysis': (task) => `ä¸“æ³¨äºä»£ç åˆ†æçš„æç¤ºè¯...`,
};

// å¯é€‰ä½¿ç”¨æ¨¡æ¿
Task({
  description: 'æŸ¥æ‰¾æ–‡ä»¶',
  prompt: '...',
  template: 'file-search'  // ğŸ†• å¯é€‰ä½¿ç”¨æ¨¡æ¿
})
```

### 3. ç»“æœç¼“å­˜
```typescript
// å¯¹ç›¸åŒä»»åŠ¡ç¼“å­˜ç»“æœ
const cacheKey = hash({ description, prompt, model });
if (cache.has(cacheKey)) {
  return cache.get(cacheKey);
}
```

## ğŸ“š å‚è€ƒèµ„æ–™

- **Claude Code å®˜æ–¹æ–‡æ¡£**: https://docs.claude.com/en/docs/claude-code/
- **è®¾è®¡è®¨è®º**: src/tools/builtin/task/task.ts é¡¶éƒ¨æ³¨é‡Š
- **æ—§å®ç°ï¼ˆæš‚å­˜åŒºï¼‰**: git stash ä¸­ä¿å­˜

## ğŸ‰ æ€»ç»“

è¿™æ¬¡é‡æ„é‡‡ç”¨äº†"å°‘å³æ˜¯å¤š"çš„è®¾è®¡å“²å­¦ï¼š

1. âœ… **ç§»é™¤ä¸å¿…è¦çš„å¤æ‚æ€§** - ä¸å†éœ€è¦ subagent_type
2. âœ… **ä¿¡ä»»æ¨¡å‹çš„èƒ½åŠ›** - è®©æ¨¡å‹è‡ªå·±å†³å®šç­–ç•¥
3. âœ… **åŠ¨æ€é€‚åº”** - æ ¹æ®ä»»åŠ¡å†…å®¹ç”Ÿæˆåˆé€‚çš„æç¤ºè¯
4. âœ… **ä¿æŒç®€æ´** - åªæœ‰ 2 ä¸ªå¿…éœ€å‚æ•°

ç»“æœæ˜¯ä¸€ä¸ªæ›´ç®€æ´ã€æ›´çµæ´»ã€æ›´æ˜“ç”¨çš„ Task å·¥å…·ã€‚
